# 页面新能优化

## 浏览器部分

1. 浏览器结构

- 用户界面 user interface
- 浏览器引擎 browser engine
  在用户界面和渲染引擎之间传送指令
- 渲染引擎 rendering engine
  负责显示请求的内容, 解析 html css, 并将解析后的内容显示在屏幕上
- 网络 networking
  用于网络调用, 比如 http 请求
- 用户界面后端 UI backend
  用于绘制基本的窗口小组件, 比如组合框和窗口
- js 解释器 javascript interpreter
  用于解释及执行 js 代码, 比如 v8
  js 引擎线程负责解析 js 脚本, 运行代码
  js 引擎一直等待任务队列中任务的到来, 然后加以处理, 一个 tab 页(renderer 进程)中只有一个 js 线程在运行
- 数据存储 data persistence
  持久层, 浏览器需要在硬盘上保存各种数据, 例如 cookie. html5 规范定义了网络数据库, 这是一个完整但是轻便的浏览器内核数据库

2. 浏览器是多进程的

- Browser 进程
  浏览器的主进程, 只有一个
  负责浏览器界面显示, 与用户交互, 如前进后退等
  负责各个页面的管理, 创建和销毁其他进程
  将 Renderer 进程得到的内存中的 Bitmap, 绘制到用户界面上
  网络资源的管理, 下载等
- 第三方插件进程
  每种类型的插件对应一个进程, 仅当使用时才会创建
- GPU 进程
  最多一个, 用于 3D 绘制等
- 渲染进程(Renderer 进程, 内部是多线程的)
  默认每个 tab 页面一个进程, 互不影响
  主要作用是页面渲染, 脚本执行, 事件处理

3. 渲染进程

- GUI 渲染线程
  负责渲染浏览器界面, 解析 html css 构建 DOM 树和 RenderObject 树, 布局和绘制等
  当界面需要重绘或者某种操作引发的回流时, 该线程就会执行
  GUI 线程和 JS 引擎线程是互斥的, 当 js 引擎执行时 GUI 线程就会被挂起(冻结), GUI 更新会被保存在一个队列中等到 js 殷勤空闲时立即被执行
- js 引擎线程
  也称为 js 内核, 负责处理 js 脚本
  js 引擎线程负责解析运行 js 脚本
  js 引擎一致等待任务队中任务的到来, 然后加以处理, 一个 tab 页(renderer 进程)中只有一个 js 线程在运行
  GUI 与 js 引擎线程是互斥的, 这就是为什么加载 js 的时候会阻塞页面渲染
- 事件触发线程
  管理事件队列
  监听事件, 符合条件时把把回调函数放入事件队列中
- 定时器线程
  setInterval 和 setTimeout 计时完毕后, 将回调函数放入事件队列中
  浏览器中定时器并不是由 js 引擎计数的(因为 js 引擎线程是单线程吗如果处于阻塞线程状态会影响计时的准确)
- 异步 http 线程
  检测到 XHR 对象发生变化时, 将回调函数放入事件队列中
  检测到状态变更时, 如果设置有回调函数, 异步线程就产生状态变更事件, 将这个回调再放入事件队列中, 由 js 引擎执行

**_渲染线程与 js 引擎线程互斥_**

由于 js 是可以操作 DOM 的, 如果再修改这些元素的同时渲染界面(即 js 引擎线程和渲染线程同时运行), 那么渲染线程前后获得的元素可能不一致
为了防止出现渲染不可预期的后果, 浏览器设置 GUI 渲染线程和 js 引擎线程互为排斥的关系, 当 js 引擎线程执行时 GUI 线程会被挂起, GUI 更新会被保存在一个队列中等到 js 引擎线程空闲时立即执行

## 浏览器的渲染机制

设备刷新频率时设备屏幕的渲染频率, 常用设备的默认刷新率时 60FPS, 就是屏幕在 1 秒内刷新了 60 次, 约 16.7ms 渲染一次屏幕
这意味着浏览器最佳的渲染性能就是所有操作在一帧(16.7ms)内完成, 能否在一帧内完成渲染影响用户的交互
渲染引擎会从网络层获取请求文档的内容, 内容大小一般限制在 8000 个块以内
`ParsingHTML to construct the DOM tree => Render tree construction => Layout of the Render tree => Pating the render tree`
渲染引擎解析HTML文档, 将各个标记转化为DomTree上的DOM节点, 同时结汇解析外部css文件以及样式元素中的样式数据, HTML中这些带有试觉指令的信息将创建RenderTree
RenderTree包含多个带有试觉属性(如颜色和尺寸)的矩形, 这些矩形的排列顺序就是他们在屏幕上显示的顺序
RenderTree构建完毕后吗进入"布局"阶段, 为每个节点分配出一个在屏幕上的确切坐标
在绘制阶段, 渲染引擎会遍历RenderTree, 用户界面后端层将每个节点绘制出来

需要指出的是,
